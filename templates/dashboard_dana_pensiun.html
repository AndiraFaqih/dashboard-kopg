<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Dana Pensiun</title>

    <!-- KWD Dashboard skin -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='kwd/css/main.css') }}"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind runtime -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
      :root {
        --primary: #994038;
        --primary-light: #B85A52;
        --primary-lighter: #D4837C;
        --primary-dark: #7A3028;
        --primary-50: #FDF5F4;
        --primary-100: #FAEAE8;
      }
      body {
        font-family: 'Noto Sans', system-ui, -apple-system, BlinkMacSystemFont,
          'Segoe UI', sans-serif;
        background: #F9FAFB;
      }
      
      /* Sidebar styling */
      .sidebar {
        background: linear-gradient(180deg, #994038 0%, #7A3028 100%);
      }
      
      /* Filter panel */
      .filter-panel {
        background: #ffffff;
        border: 1px solid #E5E7EB;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      
      /* KPI Cards */
      .kpi-card {
        background: #ffffff;
        border: 1px solid #E5E7EB;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      .kpi-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }
      .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
      }
      .kpi-card.kpi-primary::before { background: linear-gradient(90deg, #994038, #B85A52); }
      .kpi-card.kpi-success::before { background: linear-gradient(90deg, #059669, #10B981); }
      .kpi-card.kpi-warning::before { background: linear-gradient(90deg, #D97706, #F59E0B); }
      .kpi-card.kpi-danger::before { background: linear-gradient(90deg, #DC2626, #EF4444); }
      .kpi-card.kpi-info::before { background: linear-gradient(90deg, #0891B2, #06B6D4); }
      
      /* Legacy card class */
      .card {
        background: #ffffff;
        border: 1px solid #E5E7EB;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      
      /* Chart cards */
      .chart-card {
        background: #ffffff;
        border: 1px solid #E5E7EB;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      
      /* Glass panel */
      .glass {
        background: #ffffff;
        border: 1px solid #E5E7EB;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      
      /* Header gradient text */
      .text-gradient {
        background: linear-gradient(135deg, #994038 0%, #B85A52 50%, #994038 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      /* Button styling */
      .btn-primary {
        background: linear-gradient(135deg, #994038 0%, #B85A52 100%);
        box-shadow: 0 2px 8px rgba(153, 64, 56, 0.25);
        transition: all 0.2s ease;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #7A3028 0%, #994038 100%);
      }
      
      /* Positive/Negative indicators */
      .indicator-positive { color: #059669; }
      .indicator-negative { color: #DC2626; }
      
      /* Select styling */
      select:focus {
        border-color: #994038;
        box-shadow: 0 0 0 3px rgba(153, 64, 56, 0.1);
      }
      
      /* Text color overrides for light theme */
      .text-slate-100, .text-slate-200, .text-slate-300 {
        color: #1f2937 !important;
      }
      .text-slate-400 {
        color: #4b5563 !important;
      }
      .text-slate-50 {
        color: #1f2937 !important;
      }
      
      /* Icon arrow-right: hilangkan box dan buat hitam */
      [data-icon="tabler:arrow-right"] {
        color: #000000 !important;
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      [data-icon="tabler:arrow-right"] svg {
        fill: #000000 !important;
        background: transparent !important;
        border: none !important;
      }
      [data-icon="tabler:arrow-right"] svg path {
        fill: #000000 !important;
        stroke: #000000 !important;
      }
    </style>
  </head>

  <body class="antialiased min-h-screen" style="background-color: #FCF5EE;">
    {# --- MACROS --- #}
    {% macro fmt_rp_mlr(v) -%}
      {%- if v is not none -%}
        {# v dalam satuan Miliar #}
        {%- set val = v if v < 1000 else (v / 1000) -%}
        {%- set suf = 'Miliar' if v < 1000 else 'T' -%}
        Rp {{ "{:,.2f}".format(val).replace(",", ".") }} {{ suf }}
      {%- else -%}
        -
      {%- endif -%}
    {%- endmacro %}

    {% macro fmt_pct(v) -%}
      {%- if v is not none -%}
        {{ "{:,.2f}%".format(v).replace(",", ".") }}
      {%- else -%}
        -
      {%- endif -%}
    {%- endmacro %}

    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside
        class="hidden lg:flex w-64 flex-col"
        style="background: linear-gradient(180deg, #850E35 0%, #6B0B2A 100%);"
      >
        <div
          class="px-6 py-5 flex items-center gap-3 border-b border-slate-800"
        >
          <img 
            src="{{ url_for('static', filename='kwd/images/logo.jpeg') }}" 
            alt="Logo OJK KOPG" 
            class="h-14 w-14 object-contain"
          >
          <div>
            <p class="text-sm text-white">OJK</p>
            <p class="text-lg font-semibold text-white">KOPG</p>
          </div>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
          <!-- Perbankan -->
          <a
            class="flex items-center px-3 py-3 rounded-xl text-white hover:opacity-90"
            href="{{ url_for('dashboard') }}"
          >
            <span class="font-semibold">Perbankan</span>
          </a>

          <!-- Non Bank - Dropdown -->
          <div class="space-y-1" x-data="{ open: true }">
            <button
              @click="open = !open"
              class="w-full flex items-center justify-between px-3 py-3 rounded-xl text-white hover:opacity-90"
            >
              <span>Non Bank</span>
              <span
                class="iconify transition-transform duration-200"
                :class="{ 'rotate-90': open }"
                data-icon="tabler:arrow-right"
                style="color: #000000; background: transparent;"
              ></span>
            </button>

            <div x-show="open" x-transition class="ml-4 space-y-1 mt-1">
              <a
                class="flex items-center px-3 py-2 rounded-lg text-slate-200 bg-primary/20 border border-primary/40"
                href="{{ url_for('dashboard_dana_pensiun') }}"
              >
                <span class="text-sm font-semibold">Dana Pensiun</span>
              </a>
              <a
                class="flex items-center px-3 py-2 rounded-lg text-white/80 hover:text-white hover:bg-white/10"
                href="{{ url_for('dashboard_asuransi') }}"
              >
                <span class="text-sm">Asuransi</span>
              </a>
            </div>
          </div>

          <!-- Komoditas -->
          <a
            class="flex items-center px-3 py-3 rounded-xl text-white hover:opacity-90"
            href="{{ url_for('dashboard_komoditas') }}"
          >
            <span>Komoditas</span>
          </a>

          <!-- Input Data -->
          <a
            class="flex items-center px-3 py-3 rounded-xl text-white hover:opacity-90"
            href="{{ url_for('input_data') }}"
          >
            <span>Input Data</span>
          </a>
        </nav>
      </aside>

      <!-- Main -->
      <div class="flex-1 flex flex-col">
        <header class="bg-white border-b" style="border-color: #FFC4C4;">
          <div class="flex items-center justify-between px-4 sm:px-6 lg:px-10 py-4">
            <div>
              <p class="text-xs uppercase tracking-widest font-semibold" style="color: #EE6983;">Non Bank</p>
              <h1 class="text-2xl sm:text-3xl font-bold" style="color: #850E35;">Dashboard Dana Pensiun</h1>
            </div>
            <div class="flex items-center gap-3">
              <button class="h-10 w-10 rounded-xl flex items-center justify-center hover:bg-gray-100 border-2" style="color: #EE6983; border-color: #FFC4C4;">
                <span class="iconify tabler--bell text-lg"></span>
              </button>
              <img src="{{ url_for('static', filename='kwd/images/avatar.jpeg') }}" alt="avatar" class="h-10 w-10 rounded-full border-2" style="border-color: #FFC4C4;" />
            </div>
          </div>
        </header>

        <main
          class="flex-1 px-4 sm:px-6 lg:px-10 py-8 space-y-6"
        >
          <!-- Filters -->
          <form
            method="get"
            class="bg-white rounded-2xl px-6 py-5 border-2" style="border-color: #FFC4C4;"
          >
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
            <div>
              <label
                class="block text-xs font-semibold text-gray-700 mb-2"
                >Negara</label
              >
              <select
                name="negara"
                class="w-full rounded-xl border-2 text-sm px-4 py-2.5 bg-white focus:outline-none" style="border-color: #FFC4C4; color: #374151;"
              >
                <option value="">Semua</option>
                {% for n in negara_list %}
                <option
                  value="{{ n }}"
                  {% if n == negara_selected %}selected{% endif %}
                >
                  {{ n }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label
                class="block text-xs font-semibold text-gray-500 uppercase mb-2"
                >Provinsi</label
              >
              <select
                name="provinsi"
                class="w-full rounded-xl border-2 text-sm px-4 py-2.5 bg-white focus:outline-none" style="border-color: #FFC4C4; color: #374151;"
              >
                <option value="">Semua</option>
                {% for p in provinsi_list %}
                <option
                  value="{{ p }}"
                  {% if p == provinsi_selected %}selected{% endif %}
                >
                  {{ p }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label
                class="block text-xs font-semibold text-gray-500 uppercase mb-2"
                >Tahun (anchor)</label
              >
              <select
                name="tahun"
                class="w-full rounded-xl border-2 text-sm px-4 py-2.5 bg-white focus:outline-none" style="border-color: #FFC4C4; color: #374151;"
              >
                <option value="">Semua</option>
                {% for t in tahun_list %}
                <option
                  value="{{ t }}"
                  {% if t|string == tahun_selected %}selected{% endif %}
                >
                  {{ t }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label
                class="block text-xs font-semibold text-gray-500 uppercase mb-2"
                >Bulan (anchor)</label
              >
              <select
                name="bulan"
                class="w-full rounded-xl border-2 text-sm px-4 py-2.5 bg-white focus:outline-none" style="border-color: #FFC4C4; color: #374151;"
              >
                <option value="">Semua</option>
                {% for b in bulan_list %}
                <option
                  value="{{ b }}"
                  {% if b|string == bulan_selected %}selected{% endif %}
                >
                  {{ "%02d"|format(b) }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label
                class="block text-xs font-semibold text-gray-500 uppercase mb-2"
                >Rentang Waktu</label
              >
              <select
                name="interval"
                class="w-full rounded-xl border-2 text-sm px-4 py-2.5 bg-white focus:outline-none" style="border-color: #FFC4C4; color: #374151;"
              >
                <option
                  value="bulanan"
                  {% if interval_selected=='bulanan' %}selected{% endif %}
                >
                  Bulanan
                </option>
                <option
                  value="triwulan"
                  {% if interval_selected=='triwulan' %}selected{% endif %}
                >
                  Triwulan
                </option>
                <option
                  value="semesteran"
                  {% if interval_selected=='semesteran' %}selected{% endif %}
                >
                  Semesteran
                </option>
                <option
                  value="tahunan"
                  {% if interval_selected=='tahunan' %}selected{% endif %}
                >
                  Tahunan
                </option>
              </select>
            </div>
            <div
              class="flex gap-3 md:col-span-2 lg:col-span-1 justify-end"
            >
              <button
                type="submit"
                class="px-4 py-2.5 rounded-xl text-sm font-semibold text-white" style="background-color: #850E35;"
              >
                Terapkan
              </button>
              <a
                href="{{ url_for('dashboard_dana_pensiun') }}"
                class="px-4 py-2.5 rounded-xl text-sm font-semibold border-2" style="border-color: #FFC4C4; color: #850E35;"
              >
                Reset
              </a>
            </div>
            </div>
          </form>

          <!-- KPI Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            <!-- Aset -->
            <div class="card rounded-2xl p-5 border border-primary/40">
              <div>
                <p class="text-xs font-semibold text-gray-500 uppercase">
                  ASET DANA PENSIUN
                </p>
                <p class="text-2xl font-bold mt-2">
                  {{ fmt_rp_mlr(dp_aset_val) }}
                </p>
              </div>
              <div class="flex gap-4 mt-4 text-xs">
                <div>
                  <p class="text-slate-300/70">YtD</p>
                  <p class="font-semibold text-{{ dp_aset_ytd_class }}">
                    {{ fmt_pct(dp_aset_ytd) }}
                  </p>
                </div>
                <div>
                  <p class="text-slate-300/70">YoY</p>
                  <p class="font-semibold text-{{ dp_aset_yoy_class }}">
                    {{ fmt_pct(dp_aset_yoy) }}
                  </p>
                </div>
              </div>
            </div>

            <!-- Aset Neto -->
            <div class="card rounded-2xl p-5 border border-emerald-400/40">
              <div>
                <p class="text-xs font-semibold text-gray-500 uppercase">
                  ASET NETO
                </p>
                <p class="text-2xl font-bold mt-2">
                  {{ fmt_rp_mlr(dp_asetnet_val) }}
                </p>
              </div>
              <div class="flex gap-4 mt-4 text-xs">
                <div>
                  <p class="text-slate-300/70">YtD</p>
                  <p class="font-semibold text-{{ dp_asetnet_ytd_class }}">
                    {{ fmt_pct(dp_asetnet_ytd) }}
                  </p>
                </div>
                <div>
                  <p class="text-slate-300/70">YoY</p>
                  <p class="font-semibold text-{{ dp_asetnet_yoy_class }}">
                    {{ fmt_pct(dp_asetnet_yoy) }}
                  </p>
                </div>
              </div>
            </div>

            <!-- Investasi -->
            <div class="card rounded-2xl p-5 border border-amber-400/40">
              <div>
                <p class="text-xs font-semibold text-gray-500 uppercase">
                  INVESTASI
                </p>
                <p class="text-2xl font-bold mt-2">
                  {{ fmt_rp_mlr(dp_invest_val) }}
                </p>
              </div>
              <div class="flex gap-4 mt-4 text-xs">
                <div>
                  <p class="text-slate-300/70">YtD</p>
                  <p class="font-semibold text-{{ dp_invest_ytd_class }}">
                    {{ fmt_pct(dp_invest_ytd) }}
                  </p>
                </div>
                <div>
                  <p class="text-slate-300/70">YoY</p>
                  <p class="font-semibold text-{{ dp_invest_yoy_class }}">
                    {{ fmt_pct(dp_invest_yoy) }}
                  </p>
                </div>
              </div>
            </div>

            <!-- Jumlah Dana Pensiun -->
            <div class="card rounded-2xl p-5 border border-rose-400/40">
              <div>
                <p class="text-xs font-semibold text-gray-500 uppercase">
                  JUMLAH DANA PENSIUN
                </p>
                <p class="text-2xl font-bold mt-2">
                  {{ "{:,.0f}".format(dp_jumlah_val).replace(",", ".") }}
                </p>
              </div>
              <div class="flex gap-4 mt-4 text-xs">
                <div>
                  <p class="text-slate-300/70">YtD</p>
                  <p class="font-semibold text-{{ dp_jumlah_ytd_class }}">
                    {{ fmt_pct(dp_jumlah_ytd) }}
                  </p>
                </div>
                <div>
                  <p class="text-slate-300/70">YoY</p>
                  <p class="font-semibold text-{{ dp_jumlah_yoy_class }}">
                    {{ fmt_pct(dp_jumlah_yoy) }}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Mini charts: Aset & Investasi -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="chart-card rounded-2xl p-4">
              <div class="flex items-center justify-between mb-3">
                <p class="text-sm font-semibold text-slate-200">
                  Tren Aset
                </p>
              </div>
              <canvas id="dpMiniAsetChart" height="180"></canvas>
            </div>
            <div class="chart-card rounded-2xl p-4">
              <div class="flex items-center justify-between mb-3">
                <p class="text-sm font-semibold text-slate-200">
                  Tren Investasi
                </p>
              </div>
              <canvas id="dpMiniInvChart" height="180"></canvas>
            </div>
          </div>

          <!-- Rasio Investasi/Aset & Aset Neto/Aset (Desember) - DIPISAH -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Rasio Investasi/Aset -->
            <div class="chart-card rounded-2xl p-5">
              <p class="text-sm font-semibold text-slate-200 mb-3">
                Rasio Investasi/Aset (Desember)
              </p>
              <canvas id="dpInvAsetRatioChart" height="200"></canvas>
            </div>

            <!-- Rasio Aset Neto/Aset -->
            <div class="chart-card rounded-2xl p-5">
              <p class="text-sm font-semibold text-slate-200 mb-3">
                Rasio Aset Neto/Aset (Desember)
              </p>
              <canvas id="dpAsetNetoRatioChart" height="200"></canvas>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Iconify -->
    <script src="https://code.iconify.design/2/2.2.1/iconify.min.js"></script>
    <!-- KWD base JS -->
    <script
      src="{{ url_for('static', filename='kwd/js/main.js') }}"
      defer
    ></script>
    <!-- Alpine.js -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <script>
      const brand = {
        primary: '#994038',
        secondary: '#22d3ee',
        slate: '#1e293b',
        accent: '#d16b5f',
      };

      // Data dari build_dana_pensiun_context
      const dpMiniLabels = {{ dp_mini_labels|tojson }};
      const dpMiniAset = {{ dp_mini_aset|tojson }};
      const dpMiniInv = {{ dp_mini_invest|tojson }};

      const dpRatioLabels = {{ dp_ratio_labels|tojson }};
      const dpInvAsetRatioSeries = {{ dp_ratio_invest|tojson }};
      const dpAsetNetoRatioSeries = {{ dp_ratio_asetnet|tojson }};

      Chart.register(ChartDataLabels);
      Chart.defaults.color = 'black';
      Chart.defaults.borderColor = '#1f2a44';
      Chart.defaults.plugins.datalabels =
        Chart.defaults.plugins.datalabels || {};

      const transparent = (hex, alpha = 0.35) =>
        hex.startsWith('#')
          ? `rgba(${parseInt(hex.substr(1, 2), 16)},${parseInt(
              hex.substr(3, 2),
              16
            )},${parseInt(hex.substr(5, 2), 16)},${alpha})`
          : hex;

      const makeMiniBarChart = (id, labels, data, color) => {
        const el = document.getElementById(id);
        if (!el) return;
        new Chart(el, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                data,
                backgroundColor: transparent(color, 0.35),
                borderColor: color,
                borderWidth: 1.5,
                borderRadius: 10,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              datalabels: { display: false },
            },
            scales: {
              x: { grid: { display: false } },
              y: { grid: { color: '#1f2937' } },
            },
          },
        });
      };

      // Mini charts (Aset & Investasi)
      makeMiniBarChart('dpMiniAsetChart', dpMiniLabels, dpMiniAset, brand.primary);
      makeMiniBarChart('dpMiniInvChart', dpMiniLabels, dpMiniInv, '#22d3ee');

      // Rasio Investasi/Aset (Desember)
      (() => {
        const ctx = document.getElementById('dpInvAsetRatioChart');
        if (!ctx) return;
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: dpRatioLabels,
            datasets: [
              {
                label: 'Investasi/Aset (%)',
                data: dpInvAsetRatioSeries,
                borderColor: '#22d3ee',
                backgroundColor: transparent('#22d3ee', 0.3),
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#0b1224',
                pointBorderColor: '#22d3ee',
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              datalabels: { display: false },
            },
            scales: {
              y: {
                grid: { color: '#1f2937' },
                ticks: { callback: (v) => `${v}%` },
              },
              x: { grid: { display: false } },
            },
          },
        });
      })();

      // Rasio Aset Neto/Aset (Desember)
      (() => {
        const ctx = document.getElementById('dpAsetNetoRatioChart');
        if (!ctx) return;
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: dpRatioLabels,
            datasets: [
              {
                label: 'Aset Neto/Aset (%)',
                data: dpAsetNetoRatioSeries,
                borderColor: '#994038',
                backgroundColor: transparent('#994038', 0.3),
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#0b1224',
                pointBorderColor: '#994038',
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              datalabels: { display: false },
            },
            scales: {
              y: {
                grid: { color: '#1f2937' },
                ticks: { callback: (v) => `${v}%` },
              },
              x: { grid: { display: false } },
            },
          },
        });
      })();

      // Theme toggle
      (() => {
        const key = 'theme';
        const btn = document.getElementById('themeToggle');
        const prefersDark =
          window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: dark)').matches;
        const initial =
          localStorage.getItem(key) || (prefersDark ? 'dark' : 'light');

        const applyTheme = (mode) => {
          const body = document.body;
          if (mode === 'light') {
            body.classList.add('theme-light');
          } else {
            body.classList.remove('theme-light');
          }
          localStorage.setItem(key, mode);
          if (btn) {
            btn
              .querySelector('.iconify')
              ?.setAttribute(
                'data-icon',
                mode === 'light' ? 'tabler:moon' : 'tabler:sun'
              );
          }
        };

        applyTheme(initial);
        btn?.addEventListener('click', () => {
          const next = document.body.classList.contains('theme-light')
            ? 'dark'
            : 'light';
          applyTheme(next);
        });
      })();
    </script>
  </body>
</html>
